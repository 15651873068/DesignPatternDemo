# 登录注册功能的实现

**Author : ToMax**

> 在本篇博客中，将具体的讨论如何完成登录注册功能。

## 首先，分析一波需求，确定将要实现哪些功能

> 考虑到部分同学没有开发经验，所以，这里简化部分注册登录的功能

### 注册

+ 用户填写用户名、密码，进行注册(这里简化注册流程，不谈手机验证或者邮箱验证注册)

+ 注册用户名查重

### 登录

+ 用户名、密码登录系统

+ 登录状态记录

+ 记住密码

+ 登录注销

## 数据库设计

> 确定了需求之后，需要建相应的表，这里涉及到的仅有用户功能，所以只需要建立`user`表(真实过程中，需要考虑整体的需求，不能只关注这一个功能去建表，这里简化)

``` sql
表名 : user
字段如下 :
    字段名     数据类型      长度        是否主键   是否自增     备注
    id          int                     Y           Y       用户的id，唯一主键
    name        varchar     64          N           N          用户名
    password    varchar     32          N           N            密码
    time        datetime                N           N          注册时间
    ...         ...         ...         ...             ...
    这里仅列出必须的几个字段(时间非必须，可结合自身需要预留一些字段，如性别、年龄、手机号、邮箱、登录次数、用户状态等等，以备功能扩展)
```

建表截图如下:

![](https://tomax.xin/img/blog/5/10.png)

或者有如下建表语句
```sql
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(64) DEFAULT NULL,
  `password` varchar(32) DEFAULT NULL,
  `time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
```

建完表后有两种思路（对于一个人而言），一种是先完成后端的功能接口，一种是先实现前端页面。这里我是先实现后端的一些基本的接口，然后完成界面并实现对接，最终再实现一些额外的功能。

## 实现后端的接口

这里，需要界定的功能是，注册相当于插入数据，登录相当于查询数据，用户名查重也是查询功能，其他的功能与数据库操作无关，所以目前也只实现这部分功能。

注：如下过程，相关的知识大部分都在前面博客中讲过了，所以有看不懂的可以回顾一下前面的博客。

### 第一步，生成`entity`与`dao`

+ 根据`user`表生成`UserEntity`

当字段变多时，手工去写不仅工作量较大，并且容易出错，有兴趣的话可以研究一下如何自动将表映射出实体类，因为涉及别的框架的引入，所以这里不去扩展，其实很简单，只需要百度或者google一下即可。

``` java
import java.sql.Timestamp;

/**
 * @Author: ToMax
 * @Description:
 * @Date: Created in 2018/5/4 22:23
 */
public class UserEntity {
    private Integer id;
    private String name;
    private String password;
    private Timestamp time;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public Timestamp getTime() {
        return time;
    }

    public void setTime(Timestamp time) {
        this.time = time;
    }
}
```

这里简单提一下的是，数据库中的`datetime`可以在`java`中表述为`Timestamp`类型

+ 完成`IUserDao`

生成`IUserDao`接口

``` java
import cn.nuaa.tomax.entity.UserEntity;

import java.util.List;

/**
 * @Author: ToMax
 * @Description:
 * @Date: Created in 2018/5/4 22:25
 */
public interface IUserDao {
    /**
     * 新增用户
     * @param sql
     * @param user
     */
    public void saveUser(String sql, UserEntity user);

    /**
     * 根据条件获取用户列表
     * @param sql
     * @param keys
     * @return
     */
    public List<UserEntity> listUsers(String sql, Object[] keys);
}
```
仅简单的定义两个接口

+ 完成`IUserDao`的实现类`UserDaoImpl`

在`dao.impl`目录下创建`java`类`UserDaoImpl`

``` java
import java.util.List;

/**
 * @Author: ToMax
 * @Description:
 * @Date: Created in 2018/5/4 22:29
 */
@Repository
public class UserDaoImpl extends DaoHelper implements IUserDao{
    @Override
    public void saveUser(String sql, UserEntity user) {
        this.insertByBean(sql,user);
    }

    @Override
    public List<UserEntity> listUsers(String sql, Object[] keys) {
        return this.query(sql,keys,UserEntity.class);
    }
}
```

### 第二步，实现用户业务

+ 创建`IUserService`

``` java
import cn.nuaa.tomax.entity.ResultCause;
import cn.nuaa.tomax.entity.UserEntity;

/**
 * @Author: ToMax
 * @Description:
 * @Date: Created in 2018/5/4 22:44
 */
public interface IUserService {
    /**
     * 登录验证
     * @param name
     * @param password
     * @return
     */
    public ResultCause checkUser(String name, String password);

    /**
     * 用户注册
     * @param user
     * @return
     */
    public ResultCause registerUser(UserEntity user);
}
```

+ 完成`IUserService`的实现类`UserServiceImpl`

在`service.impl`目录下新建`java`类`UserServiceImpl`

``` java
import cn.nuaa.tomax.dao.IUserDao;
import cn.nuaa.tomax.entity.ResultCause;
import cn.nuaa.tomax.entity.UserEntity;
import cn.nuaa.tomax.service.IUserService;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.sql.Timestamp;
import java.util.List;

/**
 * @Author: ToMax
 * @Description:
 * @Date: Created in 2018/5/4 22:48
 */
@Service
public class UserServiceImpl implements IUserService{
    @Resource
    private IUserDao userDao;

    @Override
    public ResultCause checkUser(String name, String password) {
        UserEntity user = getTargetUser(name);
        if (user == null){
            //未查到该用户，即用户不存在
            return new ResultCause(ResultCause.FAIL_CODE,"用户名或密码错误");
        }else if (user.getPassword().equals(password)){
            //登录验证成功
            return new ResultCause(ResultCause.SUCCESS_CODE,"登录成功");
        }
        //密码错误
        return new ResultCause(ResultCause.FAIL_CODE,"用户名或密码错误");
    }

    @Override
    public ResultCause registerUser(UserEntity user) {
        if (getTargetUser(user.getName()) != null){
            return new ResultCause(ResultCause.FAIL_CODE,"用户名已存在");
        }else {
            //设置注册时间
            user.setTime(new Timestamp(System.currentTimeMillis()));
            //id为自增字段，所以不需要在这里设置
            String sql = "insert into user (name,password,time) values (:user,:password,:time)";
            userDao.saveUser(sql,user);
        }
        return new ResultCause(ResultCause.SUCCESS_CODE,"注册成功");
    }

    /**
     * 根据用户名查找用户，因为本系统用户名唯一，所以用户名查找到的结果为单个用户对象
     * 同时，因为在登录验证和注册查重中均有查询用户对象的需求，所以将这部分代码拿出，
     * 进行复用
     * @param name
     * @return 如果查询结果非空，返回唯一的结果，否则返回空值
     */
    private UserEntity getTargetUser(String name){
        String sql = "select * from user where name = ?";
        List<UserEntity> userEntities = userDao.listUsers(sql,new Object[]{name});
        return userEntities!=null?userEntities.get(0):null;
    }
}
```

简单介绍一下


[下一篇：简单留言功能的实现](https://github.com/XingToMax/DesignPatternDemo/blob/master/blogs/%E7%AE%80%E5%8D%95%E7%95%99%E8%A8%80%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0.md)

[回到目录](https://github.com/XingToMax/DesignPatternDemo/tree/master/blogs)
<br>

> 如果有帮助的话，来颗star吧